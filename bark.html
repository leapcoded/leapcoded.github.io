<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barktargent 2026 - Shared Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .card {
            background-color: #1f2937; /* bg-gray-800 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* hover:bg-indigo-700 */
        }
        .btn-secondary {
            background-color: #374151; /* bg-gray-700 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* hover:bg-gray-600 */
        }
        .btn-danger {
            background-color: #dc2626; /* bg-red-600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* hover:bg-red-700 */
        }
        .form-input {
            width: 100%;
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #4b5563; /* border-gray-600 */
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
        }
        .form-input::placeholder {
            color: #9ca3af; /* placeholder-gray-400 */
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            transition: opacity 0.3s;
        }
        .hidden {
            display: none;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="container mx-auto p-4 md:p-8 hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white">Barktargent 2026 Planner</h1>
            <p class="text-gray-400 mt-2">A shared space to coordinate packing and travel.</p>
            <div class="mt-4 flex justify-center items-center gap-4">
                 <div class="text-xs text-gray-500 bg-gray-800 p-2 rounded-lg inline-flex items-center gap-2">
                    Logged in as: <span id="usernameDisplay" class="font-mono text-indigo-400 cursor-pointer" title="My Account">Loading...</span>
                    <button id="signOutBtn" class="btn btn-danger !p-1 !text-xs" title="Sign Out">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    </button>
                </div>
                <button id="showQrBtn" class="btn btn-secondary btn-sm !py-1 !px-2">Share via QR</button>
            </div>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <section id="packing-list-section" class="card"><h2 class="text-2xl font-bold mb-4 text-white">My Packing List</h2><form id="add-packing-item-form" class="flex gap-2 mb-4"><input type="text" id="packing-item-name" class="form-input flex-grow" placeholder="e.g., Tent, Sleeping Bag" required><button type="submit" class="btn btn-primary">Add</button></form><ul id="packing-list" class="space-y-2"></ul></section>
            <section id="item-requests-section" class="card"><h2 class="text-2xl font-bold mb-4 text-white">Requested Items</h2><form id="add-request-form" class="flex gap-2 mb-4"><input type="text" id="request-item-name" class="form-input flex-grow" placeholder="e.g., Can Opener, Sunscreen" required><button type="submit" class="btn btn-primary">Request</button></form><ul id="request-list" class="space-y-2"></ul></section>
            <section id="travel-plans-section" class="card md:col-span-2 lg:col-span-1"><h2 class="text-2xl font-bold mb-4 text-white">Travel Plans</h2><form id="travel-plan-form" class="space-y-4"><div class="hidden"><input type="text" id="travel-user-name" class="form-input" placeholder="Your Name" required></div><input type="text" id="travel-arrival" class="form-input" placeholder="Arrival (e.g., Weds 2pm)"><input type="text" id="travel-departure" class="form-input" placeholder="Departure (e.g., Sun 11am)"><input type="text" id="travel-mode" class="form-input" placeholder="Transport (e.g., Car, Train)"><textarea id="travel-notes" class="form-input" rows="2" placeholder="Notes (e.g., 'Space for 2 people')"></textarea><button type="submit" class="btn btn-success w-full">Save My Plan</button></form><div id="travel-plans-list" class="mt-6 space-y-4"></div></section>
        </main>
    </div>

    <!-- Modals -->
    <div id="loginModal" class="modal-backdrop">
        <div class="card w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-center">Welcome to the Planner!</h3>
            <p class="text-gray-300 mb-6 text-center text-sm">Sign in with your phone number to get started.</p>
            <form id="phoneSignInForm">
                <input type="tel" id="phoneNumberInput" class="form-input" placeholder="+1 555-555-5555" required>
                <p id="phoneError" class="text-red-400 text-sm mt-2 hidden"></p>
                <button type="submit" id="sendCodeBtn" class="btn btn-primary w-full mt-4">Send Verification Code</button>
            </form>
        </div>
    </div>
    <div id="verifyCodeModal" class="modal-backdrop hidden">
        <div class="card w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Enter Verification Code</h3>
            <p class="text-gray-300 mb-4 text-sm">Enter the 6-digit code we sent to your phone.</p>
            <form id="verifyCodeForm">
                <input type="text" id="verifyCodeInput" class="form-input text-center tracking-[1em]" placeholder="_ _ _ _ _ _" maxlength="6" required>
                <p id="verifyCodeError" class="text-red-400 text-sm mt-2 hidden"></p>
                <button type="submit" class="btn btn-primary w-full mt-4">Verify & Sign In</button>
            </form>
        </div>
    </div>
    <div id="accountModal" class="modal-backdrop hidden">
        <div class="card w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">My Account</h3>
            <form id="usernameForm" class="mb-6">
                <label for="usernameInput" class="block text-sm font-medium text-gray-300 mb-1">Your Username</label>
                <div class="flex gap-2">
                    <input type="text" id="usernameInput" class="form-input flex-grow" placeholder="Enter username" required>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
                <p id="usernameError" class="text-red-400 text-sm mt-2 hidden"></p>
            </form>
            <button id="closeAccountModalBtn" class="btn btn-secondary w-full mt-8">Close</button>
        </div>
    </div>
    <div id="initErrorModal" class="modal-backdrop hidden"><div class="card w-full max-w-md"><h3 class="text-xl font-bold mb-4 text-red-400">Application Error</h3><p class="text-gray-300 mb-4">Could not initialize the application. Please check your Firebase credentials in the HTML file.</p></div></div>
    <div id="authErrorModal" class="modal-backdrop hidden"><div class="card w-full max-w-md"><h3 class="text-xl font-bold mb-4 text-yellow-400">Action Required: Enable Phone Sign-In</h3><p class="text-gray-300 mb-4">The application failed to sign you in. Please enable Phone Number sign-in in your Firebase project and configure reCAPTCHA.</p><div class="text-left text-sm bg-gray-900 p-4 rounded-lg"><p class="font-bold text-gray-200">How to fix:</p><ol class="list-decimal list-inside mt-2 space-y-1 text-gray-300"><li>Go to the <a href="https://console.firebase.google.com/" target="_blank" class="text-indigo-400 underline">Firebase Console</a>.</li><li>Select your project: <strong>barkplanner</strong>.</li><li>In the left menu, go to <strong>Authentication</strong>.</li><li>Click the <strong>Sign-in method</strong> tab.</li><li>Find <strong>Phone</strong> and enable it.</li><li>Under Authentication -> Settings, add your website's domain to the <strong>Authorized domains</strong> list.</li><li>Reload this page.</li></ol></div></div></div>
    <div id="firestoreErrorModal" class="modal-backdrop hidden"><div class="card w-full max-w-lg"><h3 class="text-xl font-bold mb-4 text-yellow-400">Action Required: Update Firestore Rules</h3><p class="text-gray-300 mb-4">The application connected to the database but failed to read or write data. This is usually because of restrictive security rules in your Firebase project.</p><div class="text-left text-sm bg-gray-900 p-4 rounded-lg"><p class="font-bold text-gray-200">How to fix:</p><ol class="list-decimal list-inside mt-2 space-y-1 text-gray-300"><li>Go to the <a href="https://console.firebase.google.com/" target="_blank" class="text-indigo-400 underline">Firebase Console</a>.</li><li>Select your project: <strong>barkplanner</strong>.</li><li>In the left menu, go to <strong>Firestore Database</strong>.</li><li>Click the <strong>Rules</strong> tab.</li><li>Replace the existing rules with the following to allow logged-in users to access the data:</li></ol><pre class="bg-gray-800 text-gray-200 p-2 mt-2 rounded-md text-xs overflow-x-auto"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /item_requests/{docId} {
      allow read, write: if request.auth != null;
    }
    match /travel_plans/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
      match /packing_items/{itemId} {
        allow read, write: if request.auth.uid == userId;
      }
    }
  }
}</code></pre><p class="mt-2 text-gray-400">After updating the rules, reload this page.</p></div></div></div>
    <div id="confirmationModal" class="modal-backdrop hidden"><div class="card w-full max-w-sm"><h3 class="text-xl font-bold mb-4" id="modalTitle"></h3><p class="text-gray-300 mb-6" id="modalMessage"></p><div class="flex justify-end gap-4"><button id="modalCancel" class="btn btn-secondary">Cancel</button><button id="modalConfirm" class="btn btn-danger">Confirm</button></div></div></div>
    <div id="qrModal" class="modal-backdrop hidden"><div class="card w-full max-w-sm text-center"><h3 class="text-xl font-bold mb-4">Scan to Join!</h3><canvas id="qrCanvas"></canvas><p class="text-gray-400 mt-4 text-sm">Scan this code with another device to join this planner.</p><button id="closeQrBtn" class="btn btn-secondary w-full mt-4">Close</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, getDoc, deleteDoc, onSnapshot, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDAHz4WlysnKsO3oZaZeI0LXHtHAs5stC0",
          authDomain: "barkplanner.firebaseapp.com",
          projectId: "barkplanner",
          storageBucket: "barkplanner.firebasestorage.app",
          messagingSenderId: "105053819446",
          appId: "1:105053819446:web:f096132d8b4a52a8347e97",
          measurementId: "G-KRQRVW2LSJ"
        };

        let app, auth, db;
        let userId = null;
        let username = null;
        let userDocRef = null;
        let usernames = {}, packingItems = [], requestItems = [], travelPlans = [];

        const USERS_COLLECTION = 'users';
        const REQUESTS_COLLECTION = 'item_requests';
        const TRAVEL_COLLECTION = 'travel_plans';

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            document.getElementById('initErrorModal').classList.remove('hidden');
        }

        const appContainer = document.getElementById('app');
        const loginModal = document.getElementById('loginModal');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const packingForm = document.getElementById('add-packing-item-form');
        const packingItemNameInput = document.getElementById('packing-item-name');
        const packingList = document.getElementById('packing-list');
        const requestForm = document.getElementById('add-request-form');
        const requestItemNameInput = document.getElementById('request-item-name');
        const requestList = document.getElementById('request-list');
        const travelForm = document.getElementById('travel-plan-form');
        const travelPlansList = document.getElementById('travel-plans-list');
        const confirmationModal = document.getElementById('confirmationModal');
        const modalConfirmBtn = document.getElementById('modalConfirm');
        const modalCancelBtn = document.getElementById('modalCancel');
        const accountModal = document.getElementById('accountModal');
        const usernameForm = document.getElementById('usernameForm');
        const usernameInput = document.getElementById('usernameInput');
        const usernameError = document.getElementById('usernameError');
        const closeAccountModalBtn = document.getElementById('closeAccountModalBtn');
        const qrModal = document.getElementById('qrModal');
        const showQrBtn = document.getElementById('showQrBtn');
        const closeQrBtn = document.getElementById('closeQrBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const phoneSignInForm = document.getElementById('phoneSignInForm');
        const phoneNumberInput = document.getElementById('phoneNumberInput');
        const phoneError = document.getElementById('phoneError');
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        const verifyCodeModal = document.getElementById('verifyCodeModal');
        const verifyCodeForm = document.getElementById('verifyCodeForm');
        const verifyCodeInput = document.getElementById('verifyCodeInput');
        const verifyCodeError = document.getElementById('verifyCodeError');


        function setupRecaptchaVerifier() {
            if (!window.recaptchaVerifier) {
                window.recaptchaVerifier = new RecaptchaVerifier(auth, 'sendCodeBtn', {
                    'size': 'invisible',
                    'callback': (response) => {
                        // reCAPTCHA solved, allow signInWithPhoneNumber.
                    }
                });
            }
        }

        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        userId = user.uid;
                        userDocRef = doc(db, USERS_COLLECTION, userId);
                        await checkUsername(user);
                        loadAllData();
                        loginModal.classList.add('hidden');
                        verifyCodeModal.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                    } catch (e) {
                        console.error("Error during post-login setup:", e);
                        if (e.code && (e.code.includes('permission-denied') || e.code.includes('unauthenticated'))) {
                            document.getElementById('firestoreErrorModal').classList.remove('hidden');
                        }
                        await signOut(auth);
                    }
                } else {
                    userId = null; username = null; userDocRef = null;
                    listeners.forEach(unsubscribe => unsubscribe());
                    listeners = [];
                    loginModal.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            });
        }

        async function checkUsername(user) {
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists() && userDoc.data().username) {
                username = userDoc.data().username;
                usernameDisplay.textContent = username;
            } else {
                const newUsername = user.phoneNumber || 'Guest';
                if (newUsername !== 'Guest') {
                    await setDoc(userDocRef, { username: newUsername }, { merge: true });
                    username = newUsername;
                    usernameDisplay.textContent = username;
                } else {
                    usernameDisplay.textContent = 'Guest';
                    accountModal.classList.remove('hidden'); 
                }
            }
        }

        let listeners = [];
        function loadAllData() {
            if (!userId || !db) return;
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];
            const unsub1 = onSnapshot(collection(db, USERS_COLLECTION), s => { s.docs.forEach(d => { usernames[d.id] = d.data().username || `User...${d.id.substring(0,4)}`; }); renderAll(); });
            const unsub2 = onSnapshot(collection(db, USERS_COLLECTION, userId, 'packing_items'), s => { packingItems = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); });
            const unsub3 = onSnapshot(collection(db, REQUESTS_COLLECTION), s => { requestItems = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); });
            const unsub4 = onSnapshot(collection(db, TRAVEL_COLLECTION), s => { travelPlans = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); });
            listeners.push(unsub1, unsub2, unsub3, unsub4);
        }
        
        function renderAll() { renderPackingList(); renderRequestList(); renderTravelPlans(); }
        function getUserDisplayName(uid) { return usernames[uid] || `User...${uid ? uid.substring(0,4) : '??'}`; }
        function renderPackingList() {
            packingItems.sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));
            packingList.innerHTML = '';
            if (packingItems.length === 0) { packingList.innerHTML = `<li class="text-gray-500">Nothing packed yet.</li>`; return; }
            packingItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-lg';
                li.innerHTML = `<span>${item.name}</span><button data-id="${item.id}" class="delete-packing-item btn btn-danger btn-sm !p-1 !text-xs">X</button>`;
                packingList.appendChild(li);
            });
        }
        function renderRequestList() {
            requestItems.sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));
            requestList.innerHTML = '';
            if (requestItems.length === 0) { requestList.innerHTML = `<li class="text-gray-500">No requests yet.</li>`; return; }
            requestItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-lg';
                let content = `<span>${item.name} <em class="text-xs text-gray-400">(req. by ${getUserDisplayName(item.requestedBy)})</em></span>`;
                if (item.status === 'fulfilled') {
                    content += `<span class="text-sm text-green-400">Brought by ${getUserDisplayName(item.fulfilledBy)}</span>`;
                } else {
                    content += `<button data-id="${item.id}" class="fulfill-request-item btn btn-success btn-sm !py-1 !px-2">I'll bring it!</button>`;
                }
                li.innerHTML = content;
                requestList.appendChild(li);
            });
        }
        function renderTravelPlans() {
            travelPlans.sort((a, b) => (b.updatedAt?.toDate() || 0) - (a.updatedAt?.toDate() || 0));
            travelPlansList.innerHTML = '';
            if (travelPlans.length === 0) { travelPlansList.innerHTML = `<p class="text-gray-500">No travel plans saved yet.</p>`; return; }
            travelPlans.forEach(plan => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded-lg';
                div.innerHTML = `<div class="flex justify-between items-start"><h4 class="font-bold text-lg text-indigo-300">${plan.name}</h4>${plan.userId === userId ? `<button data-id="${plan.id}" class="delete-travel-plan btn btn-danger btn-sm !p-1 !text-xs">X</button>` : ''}</div><p class="text-sm"><strong class="text-gray-400">Arrival:</strong> ${plan.arrival || 'N/A'}</p><p class="text-sm"><strong class="text-gray-400">Departure:</strong> ${plan.departure || 'N/A'}</p><p class="text-sm"><strong class="text-gray-400">Transport:</strong> ${plan.mode || 'N/A'}</p>${plan.notes ? `<p class="text-sm mt-2 pt-2 border-t border-gray-600"><strong class="text-gray-400">Notes:</strong> ${plan.notes}</p>` : ''}`;
                travelPlansList.appendChild(div);
            });
        }

        // --- Event Handlers ---
        signOutBtn.addEventListener('click', () => signOut(auth));
        
        phoneSignInForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setupRecaptchaVerifier();
            const phoneNumber = phoneNumberInput.value;
            const appVerifier = window.recaptchaVerifier;
            phoneError.classList.add('hidden');
            sendCodeBtn.disabled = true;

            try {
                const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
                window.confirmationResult = confirmationResult;
                loginModal.classList.add('hidden');
                verifyCodeModal.classList.remove('hidden');
            } catch (error) {
                console.error("SMS not sent:", error);
                phoneError.textContent = "Failed to send code. Check number or reCAPTCHA config.";
                phoneError.classList.remove('hidden');
                if (error.code === 'auth/missing-phone-number' || error.code === 'auth/invalid-phone-number') {
                    phoneError.textContent = "Please enter a valid phone number.";
                } else if (error.code === 'auth/too-many-requests') {
                    phoneError.textContent = "Too many requests. Please try again later.";
                } else {
                     document.getElementById('authErrorModal').classList.remove('hidden');
                }
                grecaptcha.reset(window.recaptchaWidgetId);
            } finally {
                sendCodeBtn.disabled = false;
            }
        });

        verifyCodeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = verifyCodeInput.value;
            verifyCodeError.classList.add('hidden');
            const verifyBtn = e.target.querySelector('button');
            verifyBtn.disabled = true;

            try {
                await window.confirmationResult.confirm(code);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Code verification failed:", error);
                verifyCodeError.textContent = "Invalid code. Please try again.";
                verifyCodeError.classList.remove('hidden');
            } finally {
                verifyBtn.disabled = false;
            }
        });

        usernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            usernameError.classList.add('hidden');
            const newUsername = usernameInput.value.trim();
            const saveButton = usernameForm.querySelector('button[type="submit"]');
            if (newUsername) {
                saveButton.disabled = true; saveButton.textContent = 'Saving...';
                try {
                    await setDoc(userDocRef, { username: newUsername }, { merge: true });
                    username = newUsername; usernameDisplay.textContent = username;
                    if (newUsername !== 'Guest') accountModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error setting username:", error);
                    usernameError.textContent = "Failed to save. Check Firestore rules.";
                    usernameError.classList.remove('hidden');
                } finally {
                    saveButton.disabled = false; saveButton.textContent = 'Save';
                }
            }
        });
        packingForm.addEventListener('submit', async (e) => { e.preventDefault(); const n = packingItemNameInput.value.trim(); if (n && userId) { await addDoc(collection(db, USERS_COLLECTION, userId, 'packing_items'), { name: n, createdAt: new Date() }); packingItemNameInput.value = ''; } });
        packingList.addEventListener('click', (e) => { if (e.target.classList.contains('delete-packing-item')) { const docId = e.target.dataset.id; showConfirmationModal('Delete Item', 'Are you sure?', () => deleteDoc(doc(db, USERS_COLLECTION, userId, 'packing_items', docId))); } });
        requestForm.addEventListener('submit', async (e) => { e.preventDefault(); const n = requestItemNameInput.value.trim(); if (n && userId) { await addDoc(collection(db, REQUESTS_COLLECTION), { name: n, requestedBy: userId, status: 'requested', fulfilledBy: null, createdAt: new Date() }); requestItemNameInput.value = ''; } });
        travelForm.addEventListener('submit', async (e) => { e.preventDefault(); if (username && userId) { await setDoc(doc(db, TRAVEL_COLLECTION, userId), { name: username, arrival: document.getElementById('travel-arrival').value, departure: document.getElementById('travel-departure').value, mode: document.getElementById('travel-mode').value, notes: document.getElementById('travel-notes').value, updatedAt: new Date(), userId: userId }); } });
        requestList.addEventListener('click', (e) => { if (e.target.classList.contains('fulfill-request-item')) { updateDoc(doc(db, REQUESTS_COLLECTION, e.target.dataset.id), { status: 'fulfilled', fulfilledBy: userId }); } });
        travelPlansList.addEventListener('click', (e) => { if (e.target.classList.contains('delete-travel-plan')) { showConfirmationModal('Delete Plan', 'Are you sure?', () => { deleteDoc(doc(db, TRAVEL_COLLECTION, e.target.dataset.id)); travelForm.reset(); }); } });
        
        usernameDisplay.addEventListener('click', () => { 
            usernameInput.value = username || ''; 
            accountModal.classList.remove('hidden'); 
        });

        showQrBtn.addEventListener('click', () => { new QRious({ element: document.getElementById('qrCanvas'), value: window.location.href, size: 256, padding: 16 }); qrModal.classList.remove('hidden'); });
        closeQrBtn.addEventListener('click', () => qrModal.classList.add('hidden'));
        modalCancelBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        closeAccountModalBtn.addEventListener('click', () => accountModal.classList.add('hidden'));
        function showConfirmationModal(title, message, onConfirm) { confirmationModal.querySelector('#modalTitle').textContent = title; confirmationModal.querySelector('#modalMessage').textContent = message; confirmCallback = onConfirm; confirmationModal.classList.remove('hidden'); }
        let confirmCallback;
        modalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); confirmationModal.classList.add('hidden'); });
    </script>
</body>
</html>
